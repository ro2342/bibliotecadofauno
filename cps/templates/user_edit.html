{% extends "layout.html" %}
{% block body %}
<div class="max-w-4xl mx-auto py-8">
  <div class="mb-10 flex items-center justify-between">
    <div>
        <h1 class="font-display text-4xl text-[var(--ink-primary)]">{{title}}</h1>
        <p class="text-neutral-500 mt-2">Gerencie suas preferências e permissões de acesso.</p>
    </div>
    <div id="user_submit_fauno" class="bg-[hsl(var(--md-sys-color-primary))] text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:scale-105 transition-all cursor-pointer">
        {{_('Save')}}
    </div>
  </div>

  <form id="user-edit-form" role="form" method="POST" autocomplete="off" class="space-y-8">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <!-- IDENTITY & SECURITY CARD -->
    <div class="card-expressive p-8 shadow-xl">
        <h2 class="font-display text-2xl mb-6 flex items-center gap-2 text-[var(--ink-primary)]">
            <span class="material-symbols-outlined text-[hsl(var(--md-sys-color-primary))]">fingerprint</span>
            Identidade & Segurança
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {% if new_user or ( current_user and content.name != "Guest" and current_user.role_admin() ) %}
            <div class="space-y-2">
                <label for="name" class="text-xs font-bold uppercase tracking-widest text-neutral-400 block ml-1">{{_('Username')}}</label>
                <input type="text" name="name" id="name" value="{{ content.name if content.name != None }}" 
                       class="w-full bg-white/40 border-2 border-transparent focus:border-[hsl(var(--md-sys-color-primary))] rounded-xl py-3 px-4 transition-all outline-none">
            </div>
            {% endif %}
            
            <div class="space-y-2">
                <label for="email" class="text-xs font-bold uppercase tracking-widest text-neutral-400 block ml-1">{{_('Email')}}</label>
                <input type="email" name="email" id="email" value="{{ content.email if content.email != None }}"
                       class="w-full bg-white/40 border-2 border-transparent focus:border-[hsl(var(--md-sys-color-primary))] rounded-xl py-3 px-4 transition-all outline-none">
            </div>

            {% if ( current_user and current_user.role_passwd() or current_user.role_admin() ) and not content.role_anonymous() %}
            <div class="space-y-2 md:col-span-2">
                <label for="password" class="text-xs font-bold uppercase tracking-widest text-neutral-400 block ml-1">{{_('Password')}}</label>
                <div class="flex gap-2">
                    <input type="password" name="password" id="password" data-lang="{{ current_user.locale }}" data-verify="{{ config.config_password_policy }}" 
                           {% if config.config_password_policy %} data-min={{ config.config_password_min_length }} data-word={{ config.config_password_character }} data-special={{ config.config_password_special }} data-upper={{ config.config_password_upper }} data-lower={{ config.config_password_lower }} data-number={{ config.config_password_number }}{% endif %}
                           class="flex-1 bg-white/40 border-2 border-transparent focus:border-[hsl(var(--md-sys-color-primary))] rounded-xl py-3 px-4 transition-all outline-none">
                    {% if current_user and current_user.role_admin() and not new_user and not profile and ( mail_configured and content.email if content.email != None ) %}
                        <div class="bg-neutral-800 text-white px-4 py-3 rounded-xl font-bold cursor-pointer hover:bg-black transition-all flex items-center postAction" data-action="{{url_for('admin.reset_user_password', user_id = content.id) }}">
                             {{_('Reset')}}
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- PREFERENCES CARD -->
    <div class="card-expressive p-8 shadow-xl">
        <h2 class="font-display text-2xl mb-6 flex items-center gap-2 text-[var(--ink-primary)]">
            <span class="material-symbols-outlined text-[hsl(var(--md-sys-color-primary))]">settings_suggest</span>
            Preferências de Leitura
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="space-y-6">
                <div class="space-y-2">
                    <label for="locale" class="text-xs font-bold uppercase tracking-widest text-neutral-400 block ml-1">{{_('Language')}}</label>
                    <select name="locale" id="locale" class="w-full bg-white/40 border-2 border-transparent focus:border-[hsl(var(--md-sys-color-primary))] rounded-xl py-3 px-4 transition-all outline-none appearance-none cursor-pointer">
                        {% for translation in translations %}
                            <option value="{{translation}}" {% if translation|string == content.locale %}selected{% endif %}>{{ translation.display_name|capitalize }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="space-y-2">
                    <label for="default_language" class="text-xs font-bold uppercase tracking-widest text-neutral-400 block ml-1">{{_('Language of Books')}}</label>
                    <select name="default_language" id="default_language" class="w-full bg-white/40 border-2 border-transparent focus:border-[hsl(var(--md-sys-color-primary))] rounded-xl py-3 px-4 transition-all outline-none appearance-none cursor-pointer">
                        <option value="all" {% if content.default_language == "all" %}selected{% endif %}>{{ _('Show All') }}</option>
                        {% for language in languages %}
                        <option value="{{ language.lang_code }}" {% if content.default_language == language.lang_code %}selected{% endif %}>{{ language.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="space-y-4 pt-2">
                <label class="text-xs font-bold uppercase tracking-widest text-neutral-400 block ml-1">Interface</label>
                {% for element in sidebar %}
                    {% if element['config_show'] %}
                    <label class="flex items-center gap-3 cursor-pointer group bg-black/5 p-3 rounded-xl hover:bg-black/10 transition-all border border-transparent hover:border-black/5">
                        <input type="checkbox" name="show_{{element['visibility']}}" data-original-id="show_{{element['visibility']}}" {% if content.check_visibility(element['visibility']) %}checked{% endif %} class="w-5 h-5 rounded border-amber-900/20 text-[hsl(var(--md-sys-color-primary))] focus:ring-[hsl(var(--md-sys-color-primary))]">
                        <span class="text-sm font-bold text-neutral-700">{{element['show_text']}}</span>
                    </label>
                    {% endif %}
                {% endfor %}
                <label class="flex items-center gap-3 cursor-pointer group bg-black/5 p-3 rounded-xl hover:bg-black/10 transition-all border border-transparent hover:border-black/5">
                    <input type="checkbox" name="Show_detail_random" {% if content.show_detail_random() %}checked{% endif %} class="w-5 h-5 rounded border-amber-900/20 text-[hsl(var(--md-sys-color-primary))] focus:ring-[hsl(var(--md-sys-color-primary))]">
                    <span class="text-sm font-bold text-neutral-700">{{_('Show Random Books in Detail View')}}</span>
                </label>
            </div>
        </div>
    </div>

    <!-- E-READER CARD -->
    <div class="card-expressive p-8 shadow-xl">
        <h2 class="font-display text-2xl mb-6 flex items-center gap-2 text-[var(--ink-primary)]">
            <span class="material-symbols-outlined text-[hsl(var(--md-sys-color-primary))]">tablet_android</span>
            Sincronização e Dispositivos
        </h2>
        <div class="space-y-6">
            <div class="space-y-2">
                <label for="kindle_mail" class="text-xs font-bold uppercase tracking-widest text-neutral-400 block ml-1">{{_('Send to eReader Email Address')}}</label>
                <input type="email" name="kindle_mail" id="kindle_mail" value="{{ content.kindle_mail if content.kindle_mail != None }}"
                       class="w-full bg-white/40 border-2 border-transparent focus:border-[hsl(var(--md-sys-color-primary))] rounded-xl py-3 px-4 transition-all outline-none">
            </div>

            {% if kobo_support and not new_user %}
            <div class="p-6 bg-white/30 rounded-2xl border border-white/40 shadow-inner flex flex-wrap items-center justify-between gap-4">
                <div>
                    <h4 class="font-bold text-[var(--ink-primary)]">{{ _('Kobo Sync Token')}}</h4>
                    <p class="text-xs text-neutral-500">Configure a sincronização direta com seu leitor Kobo.</p>
                </div>
                <div class="flex gap-2">
                    <a class="bg-neutral-800 text-white px-4 py-2 rounded-lg font-bold hover:bg-black transition-all text-sm cursor-pointer" id="config_create_kobo_token" data-toggle="modal" data-target="#modal_kobo_token" href="{{ url_for('kobo_auth.generate_auth_token', user_id=content.id) }}">
                        {{_('View/Create')}}
                    </a>
                    {% if content.remote_auth_token.first() %}
                    <div class="bg-red-100 text-red-600 px-4 py-2 rounded-lg font-bold hover:bg-red-200 transition-all text-sm cursor-pointer" id="config_delete_kobo_token_fauno" data-value="{{ content.id }}">
                        {{_('Delete')}}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ADMIN CARD IF APPLICABLE -->
    {% if current_user and current_user.role_admin() and not profile %}
    <div class="card-expressive p-8 shadow-xl border-2 border-blue-500/10">
        <h2 class="font-display text-2xl mb-6 flex items-center gap-2 text-[var(--ink-primary)]">
            <span class="material-symbols-outlined text-blue-500">security</span>
            Permissões de Administrador
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-y-4 gap-x-8">
            {% if not content.role_anonymous() %}
            <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-blue-50 rounded-lg transition-all">
                <input type="checkbox" name="admin_role" {% if content.role_admin() %}checked{% endif %} class="w-5 h-5 rounded border-blue-200 text-blue-600 focus:ring-blue-500">
                <span class="text-sm font-bold text-neutral-700">{{_('Admin User')}}</span>
            </label>
            {% endif %}
            <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-blue-50 rounded-lg transition-all">
                <input type="checkbox" name="download_role" {% if content.role_download() %}checked{% endif %} class="w-5 h-5 rounded border-blue-200 text-blue-600 focus:ring-blue-500">
                <span class="text-sm font-bold text-neutral-700">{{_('Allow Downloads')}}</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-blue-50 rounded-lg transition-all">
                <input type="checkbox" name="viewer_role" {% if content.role_viewer() %}checked{% endif %} class="w-5 h-5 rounded border-blue-200 text-blue-600 focus:ring-blue-500">
                <span class="text-sm font-bold text-neutral-700">{{_('Allow eBook Viewer')}}</span>
            </label>
            {% if config.config_uploading %}
            <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-blue-50 rounded-lg transition-all">
                <input type="checkbox" name="upload_role" {% if content.role_upload() %}checked{% endif %} class="w-5 h-5 rounded border-blue-200 text-blue-600 focus:ring-blue-500">
                <span class="text-sm font-bold text-neutral-700">{{_('Allow Uploads')}}</span>
            </label>
            {% endif %}
            <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-blue-50 rounded-lg transition-all">
                <input type="checkbox" name="edit_role" id="edit_role_fauno" {% if content.role_edit() %}checked{% endif %} class="w-5 h-5 rounded border-blue-200 text-blue-600 focus:ring-blue-500">
                <span class="text-sm font-bold text-neutral-700">{{_('Allow Edit')}}</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-blue-50 rounded-lg transition-all">
                <input type="checkbox" name="delete_role" {% if content.role_delete_books() %}checked{% endif %} class="w-5 h-5 rounded border-blue-200 text-blue-600 focus:ring-blue-500">
                <span class="text-sm font-bold text-neutral-700">{{_('Allow Delete Books')}}</span>
            </label>
            {% if not content.role_anonymous() %}
            <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-blue-50 rounded-lg transition-all">
                <input type="checkbox" name="passwd_role" {% if content.role_passwd() %}checked{% endif %} class="w-5 h-5 rounded border-blue-200 text-blue-600 focus:ring-blue-500">
                <span class="text-sm font-bold text-neutral-700">{{_('Allow Changing Password')}}</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer group p-2 hover:bg-blue-50 rounded-lg transition-all">
                <input type="checkbox" name="edit_shelf_role" {% if content.role_edit_shelfs() %}checked{% endif %} class="w-5 h-5 rounded border-blue-200 text-blue-600 focus:ring-blue-500">
                <span class="text-sm font-bold text-neutral-700">{{_('Allow Editing Public Shelves')}}</span>
            </label>
            {% endif %}
        </div>
        
        <div class="mt-8 flex gap-4">
             {% if not profile and not new_user and not content.role_anonymous() %}
                <div class="bg-red-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-red-700 transition-all text-sm cursor-pointer flex items-center gap-2" id="btndeluser" data-value="{{ content.id }}">
                    <span class="material-symbols-outlined !text-sm">delete_forever</span>
                    {{_('Delete User')}}
                </div>
            {% endif %}
            {% if not simple %}
              <div class="bg-neutral-800 text-white px-6 py-2 rounded-xl font-bold hover:bg-black transition-all text-sm cursor-pointer flex items-center gap-2" id="get_user_tags" data-id="{{content.id}}" data-toggle="modal" data-target="#restrictModal">
                  <span class="material-symbols-outlined !text-sm">label</span>
                  Tags Restritas
              </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="flex items-center gap-4 pt-10">
        <div id="user_submit_main" class="flex-1 bg-[hsl(var(--md-sys-color-primary))] text-white py-4 rounded-2xl font-bold shadow-xl shadow-[hsl(var(--md-sys-color-primary))/40%] hover:scale-[1.02] active:scale-95 transition-all text-lg text-center cursor-pointer">
            {{_('Save Changes')}}
        </div>
        <div class="bg-white border-2 border-neutral-300 py-4 px-10 rounded-2xl font-bold hover:bg-neutral-100 transition-all cursor-pointer" onclick="window.history.back()">
            {{_('Cancel')}}
        </div>
    </div>
  </form>
</div>

<!-- HIDDEN LEGACY INPUTS FOR COMPATIBILITY IF SCRIPT EXPECTS THEM BY ID -->
<div style="display:none">
    <div id="user_submit"></div>
    <div id="back"></div>
</div>

<script>
    // Bridge our new premium buttons to the target triggers
    document.getElementById('user_submit_fauno')?.addEventListener('click', () => document.getElementById('user_submit_main').click());
    document.getElementById('user_submit_main')?.addEventListener('click', () => {
        // Find the actual form submit button if present or submit the form
        document.querySelector('form#user-edit-form').submit();
    });
    // Kobo delete bridge
    document.getElementById('config_delete_kobo_token_fauno')?.addEventListener('click', () => {
        document.getElementById('config_delete_kobo_token').click();
    });
</script>

<div class="modal fade" id="modal_kobo_token" tabindex="-1" role="dialog" aria-labelledby="kobo_tokenModalLabel">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="kobo_tokenModalLabel">{{_('Generate Kobo Auth URL')}}</h4>
      </div>
      <div class="modal-body">...</div>
      <div class="modal-footer">
        <button type="button" id="kobo_close" class="btn btn-default" data-dismiss="modal">{{_('Close')}}</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block modal %}
{{ restrict_modal() }}
{{ delete_confirm_modal() }}
{% endblock %}
{% block js %}
<script src="{{ url_for('static', filename='js/libs/bootstrap-table/bootstrap-table.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/libs/bootstrap-table/bootstrap-table-editable.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/libs/bootstrap-table/bootstrap-editable.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/libs/pwstrength/i18next.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/libs/pwstrength/i18nextHttpBackend.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/libs/pwstrength/pwstrength-bootstrap.js') }}"></script>
<script src="{{ url_for('static', filename='js/password.js') }}"></script>
<script src="{{ url_for('static', filename='js/table.js') }}"></script>
{% endblock %}
