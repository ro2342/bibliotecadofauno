{% extends is_xhr|yesno("fragment.html", "layout.html") %}
{% block header %}
    <meta property="og:type" content="book" />
    <meta property="og:title" content="{{ entry.title|truncate(35) }}" />
    {% if entry.comments|length > 0 and entry.comments[0].text|length > 0 %}
      <meta property="og:description" content="{{ entry.comments[0].text|striptags|truncate(65) }}" />
      <meta property="og:image" content="{{url_for('web.get_cover', book_id=entry.id, resolution='og', c=entry|last_modified)}}" />
    {% endif %}
{% endblock %}
{% block body %}
<div class="max-w-6xl mx-auto">
    <div class="flex flex-col lg:flex-row gap-12">
        <!-- COVER SECTION -->
        <div class="w-full lg:w-1/3 flex-shrink-0">
            <div class="sticky top-24">
                <div class="card-expressive p-4 overflow-hidden shadow-2xl transition-transform duration-500 hover:scale-[1.02]">
                    <img id="detailcover" class="w-full h-auto rounded-xl shadow-inner" title="{{ entry.title }}"
                         src="{{ url_for('web.get_cover', book_id=entry.id, resolution='og', c=entry|last_modified) }}"/>
                </div>
                
                <!-- PROGRESS OVERLAY IF ACTIVE -->
                {% if entry.read_status %}
                <div class="mt-4 flex items-center justify-center gap-2 text-green-700 bg-green-100/50 py-2 rounded-full font-bold text-sm">
                    <span class="material-symbols-outlined !text-sm">verified</span>
                    {{ _('Read') }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- META SECTION -->
        <div class="w-full lg:w-2/3">
            <div class="mb-8">
                <p class="text-[hsl(var(--md-sys-color-primary))] font-bold tracking-widest uppercase text-xs mb-2">
                    {% if entry.series|length > 0 %}
                        {{ entry.series[0].name }} #{{ entry.series_index|formatfloat(2) }}
                    {% else %}
                        Biblioteca do Fauno
                    {% endif %}
                </p>
                <h1 class="font-display text-4xl md:text-6xl text-[var(--ink-primary)] leading-tight mb-4">{{ entry.title }}</h1>
                
                <div class="flex flex-wrap items-center gap-4 text-neutral-600 mb-6">
                    <p class="font-bold text-lg">
                        {% for author in entry.ordered_authors %}
                            <a href="{{ url_for('web.books_list',  data='author', sort_param='stored', book_id=author.id ) }}" class="hover:text-[hsl(var(--md-sys-color-primary))] transition-colors underline decoration-2 decoration-transparent hover:decoration-current">{{ author.name.replace('|',',') }}</a>
                            {% if not loop.last %} &amp; {% endif %}
                        {% endfor %}
                    </p>
                    <span class="text-neutral-300">|</span>
                    {% if (entry.pubdate|string)[:10] != '0101-01-01' %}
                        <p>{{ entry.pubdate|formatdate }}</p>
                    {% endif %}
                </div>

                {% if entry.ratings.__len__() > 0 %}
                <div class="flex gap-1 text-amber-500 mb-8">
                    {% for number in range((entry.ratings[0].rating/2)|int(2)) %}
                        <span class="material-symbols-outlined !text-2xl FILL">star</span>
                    {% endfor %}
                    {% for number in range(5 - (entry.ratings[0].rating/2)|int(2)) %}
                        <span class="material-symbols-outlined !text-2xl">star</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- ACTIONS -->
            <div class="flex flex-wrap gap-4 mb-12">
                {% if entry.reader_list and current_user.role_viewer() %}
                    <a target="_blank" href="{{ url_for('web.read_book', book_id=entry.id, book_format=entry.reader_list[0]) }}" 
                       class="flex items-center gap-2 border-primary bg-[hsl(var(--md-sys-color-primary))] text-white px-8 py-4 rounded-2xl shadow-xl hover:shadow-[hsl(var(--md-sys-color-primary))/40%] hover:scale-105 transition-all font-bold">
                        <span class="material-symbols-outlined">menu_book</span>
                        {{ _('Read in Browser') }}
                    </a>
                {% endif %}

                {% if current_user.role_download() and entry.data|length %}
                    <div class="relative group">
                        <button class="flex items-center gap-2 bg-white/40 backdrop-blur-md border border-white/20 px-6 py-4 rounded-2xl font-bold shadow-lg hover:bg-white/60 transition-all">
                            <span class="material-symbols-outlined">download</span>
                            {{ _('Download') }}
                        </button>
                        <div class="absolute left-0 mt-2 w-48 bg-white/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-black/5 flex-col hidden group-hover:flex z-10">
                            {% for format in entry.data %}
                            <a href="{{ url_for('web.download_link', book_id=entry.id, book_format=format.format|lower, anyname=entry.id|string+'.'+format.format|lower|replace('kepub', 'kepub.epub')) }}" 
                               class="px-4 py-3 hover:bg-[hsl(var(--md-sys-color-primary))] hover:text-white transition-colors first:rounded-t-2xl last:rounded-b-2xl">
                                {{ format.format }} ({{ format.uncompressed_size|filesizeformat }})
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                {% if not current_user.is_anonymous %}
                <div class="relative group">
                    <button id="add-to-shelf-fauno" class="flex items-center gap-2 bg-white/40 backdrop-blur-md border border-white/20 px-6 py-4 rounded-2xl font-bold shadow-lg hover:bg-white/60 transition-all">
                        <span class="material-symbols-outlined">format_list_bulleted_add</span>
                        {{ _('Shelves') }}
                    </button>
                    <!-- Shelf Dropdown logic preserved but styled -->
                    <div class="absolute left-0 mt-2 w-64 bg-white/90 backdrop-blur-xl rounded-2xl shadow-2xl border border-black/5 flex-col hidden group-hover:flex z-10 max-h-64 overflow-y-auto">
                        {% for shelf in g.shelves_access %}
                            {% if not shelf.id in books_shelfs and ( not shelf.is_public or current_user.role_edit_shelfs() ) %}
                                <a data-href="{{ url_for('shelf.add_to_shelf', book_id=entry.id, shelf_id=shelf.id) }}"
                                   data-remove-href="{{ url_for('shelf.remove_from_shelf', book_id=entry.id, shelf_id=shelf.id) }}"
                                   data-shelf-action="add"
                                   class="px-4 py-3 hover:bg-[hsl(var(--md-sys-color-primary))] hover:text-white transition-colors first:rounded-t-2xl last:rounded-b-2xl text-sm"
                                >
                                    {{ shelf.name }}{% if shelf.is_public == 1 %} {{ _('(Public)') }}{% endif %}
                                </a>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- DESCRIPTION -->
            <div class="card-expressive p-8 mb-12">
                <h3 class="font-display text-2xl mb-4 text-[var(--ink-primary)]">{{ _('Description:') }}</h3>
                <div class="prose prose-neutral max-w-none text-neutral-800 leading-relaxed font-serif text-lg">
                    {% if entry.comments|length > 0 and entry.comments[0].text|length > 0 %}
                        {{ entry.comments[0].text|safe }}
                    {% else %}
                        <p class="italic text-neutral-400 font-sans text-sm">{{ _('No description available.') }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- TAGS & INFO GRID -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h4 class="font-bold text-xs uppercase tracking-widest text-neutral-400 mb-4">{{ _('Tags') }}</h4>
                    <div class="flex flex-wrap gap-2">
                        {% for tag in entry.tags %}
                            <a href="{{ url_for('web.books_list', data='category', sort_param='stored', book_id=tag.id) }}"
                               class="bg-neutral-200/50 hover:bg-[hsl(var(--md-sys-color-primary))] hover:text-white px-3 py-1 rounded-full text-sm transition-all">{{ tag.name }}</a>
                        {% endfor %}
                    </div>
                </div>
                
                <div>
                    <h4 class="font-bold text-xs uppercase tracking-widest text-neutral-400 mb-4">{{ _('Metadata') }}</h4>
                    <ul class="space-y-2 text-sm">
                        {% if entry.languages|length > 0 %}
                            <li class="flex justify-between border-b border-black/5 pb-2">
                                <span class="text-neutral-500">{{ _('Language') }}</span>
                                <span class="font-bold">{% for language in entry.languages %}{{language.language_name}}{% if not loop.last %}, {% endif %}{% endfor %}</span>
                            </li>
                        {% endif %}
                        {% if entry.publishers|length > 0 %}
                            <li class="flex justify-between border-b border-black/5 pb-2">
                                <span class="text-neutral-500">{{ _('Publisher') }}</span>
                                <a class="font-bold hover:underline" href="{{ url_for('web.books_list', data='publisher', sort_param='stored', book_id=entry.publishers[0].id ) }}">{{ entry.publishers[0].name }}</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
            
            {% if current_user.role_edit() %}
            <div class="mt-12 pt-8 border-t border-black/5 flex gap-4">
                <a href="{{ url_for('edit-book.show_edit_book', book_id=entry.id) }}"
                   class="bg-neutral-800 text-white px-6 py-3 rounded-xl hover:bg-black transition-colors flex items-center gap-2">
                   <span class="material-symbols-outlined !text-sm">edit</span>
                   {{ _('Edit Metadata') }}
                </a>
                <div class="px-6 py-3 rounded-xl border border-neutral-300 hover:bg-neutral-100 transition-colors cursor-pointer" onclick="window.history.back()">{{_('Back')}}</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script type="text/template" id="template-shelf-add">
    <li>
        <a data-href="<%= add %>" data-remove-href="<%= remove %>" data-shelf-action="add">
            <%= content %>
        </a>
    </li>
</script>
<script type="text/template" id="template-shelf-remove">
    <a data-href="<%= remove %>" data-add-href="<%= add %>" class="btn btn-sm btn-default"
       data-shelf-action="remove">
        <span class="glyphicon glyphicon-remove"></span> <%= content %>
    </a>
</script>
<script src="{{ url_for('static', filename='js/details.js') }}"></script>
<script src="{{ url_for('static', filename='js/fullscreen.js') }}"></script>
<script type="text/javascript">
</script>

{% endblock %}
